# =============================================================================
#  ğŸ•Œ  Madina Lab â€” Terraform Pipeline (cloudbuild-tf.yaml)
# =============================================================================
#
#  Deploys infrastructure using Terraform through Cloud Build.
#
#  HOW TO USE:
#  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  cd terraform
#  gcloud builds submit --config cloudbuild-tf.yaml \
#    --substitutions=_TEAM=team1 .
#
#  PIPELINE STAGES:
#  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Step 1: INIT    â†’ Download providers (Google Cloud plugin)
#  Step 2: PLAN    â†’ Preview what will change (no changes applied yet)
#  Step 3: APPLY   â†’ Create/update the resources
#
# =============================================================================

substitutions:
  _TEAM: "team1"

steps:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 1: INIT â€” Download providers
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Terraform needs the Google Cloud provider plugin to talk to GCP.
  # This step downloads it. Think of it like `npm install` for infrastructure.
  - name: "hashicorp/terraform:latest"
    id: "init"
    entrypoint: "sh"
    args:
      - "-c"
      - |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  ğŸ“¦ Terraform Init â€” Downloading providers"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        terraform init -no-color
    dir: "."

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 2: PLAN â€” Preview changes
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Shows what Terraform WILL do â€” without doing it yet.
  # This is like a dry run. Review the output carefully:
  #   + means CREATE (new resource)
  #   ~ means UPDATE (change existing)
  #   - means DESTROY (delete resource)
  - name: "hashicorp/terraform:latest"
    id: "plan"
    entrypoint: "sh"
    args:
      - "-c"
      - |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  ğŸ” Terraform Plan â€” Preview changes"
        echo "  Team: ${_TEAM}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        terraform plan \
          -var="team=${_TEAM}" \
          -no-color
    dir: "."

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 3: APPLY â€” Create/update resources
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # This step actually creates the resources in GCP.
  # -auto-approve skips the confirmation prompt (since this is CI/CD).
  - name: "hashicorp/terraform:latest"
    id: "apply"
    entrypoint: "sh"
    args:
      - "-c"
      - |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  ğŸš€ Terraform Apply â€” Creating resources"
        echo "  Team: ${_TEAM}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        terraform apply \
          -var="team=${_TEAM}" \
          -auto-approve \
          -no-color
    dir: "."

options:
  logging: CLOUD_LOGGING_ONLY

timeout: "600s"