# =============================================================================
#  ğŸ•Œ  Madina Lab â€” Terraform Pipeline (cloudbuild-tf.yaml)
# =============================================================================
#
#  This pipeline builds the app, scans Terraform with Checkov,
#  then deploys infrastructure using Terraform.
#
#  HOW TO USE:
#  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  gcloud builds submit --config .pipelines/cloudbuild-tf.yaml \
#    --substitutions=_TEAM=team1 .
#
#  PIPELINE STAGES:
#  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Step 1: BUILD-APP    â†’ Build & push container image (same as app pipeline)
#  Step 2: CHECKOV      â†’ Scan Terraform for security & best practices
#  Step 3: TF-INIT      â†’ Download providers
#  Step 4: TF-PLAN      â†’ Preview what will change
#  Step 5: TF-APPLY     â†’ Create/update resources
#
# =============================================================================

substitutions:
  _TEAM: "team1"
  _REGION: "us-central1"
  _AR_REPO: "madina-lab"
  _PROJECT_ID: "ml-gcp-workshop-487117"

steps:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 1: BUILD-APP â€” Build & push container image
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Terraform deploys a Cloud Run service that needs an image.
  # This step builds and pushes it to Artifact Registry first.
  - name: "gcr.io/cloud-builders/docker"
    id: "build-app"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  ğŸ³ Building container image"
        echo "  Team: ${_TEAM}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        docker build \
          --build-arg VITE_FIREBASE_API_KEY=$$FIREBASE_API_KEY \
          --build-arg VITE_FIREBASE_AUTH_DOMAIN=$$FIREBASE_AUTH_DOMAIN \
          --build-arg VITE_FIREBASE_PROJECT_ID=$$FIREBASE_PROJECT_ID \
          --build-arg VITE_FIREBASE_STORAGE_BUCKET=$$FIREBASE_STORAGE_BUCKET \
          --build-arg VITE_FIREBASE_MESSAGING_SENDER_ID=$$FIREBASE_MESSAGING_SENDER_ID \
          --build-arg VITE_FIREBASE_APP_ID=$$FIREBASE_APP_ID \
          --build-arg VITE_FIREBASE_MEASUREMENT_ID=$$FIREBASE_MEASUREMENT_ID \
          --build-arg VITE_APP_ENV=production \
          --build-arg VITE_NAMESPACE=${_TEAM} \
          -t ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/madina-lab-${_TEAM}:latest \
          .
        docker push ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/madina-lab-${_TEAM}:latest
        echo "âœ” Image built and pushed"
    secretEnv:
      - "FIREBASE_API_KEY"
      - "FIREBASE_AUTH_DOMAIN"
      - "FIREBASE_PROJECT_ID"
      - "FIREBASE_STORAGE_BUCKET"
      - "FIREBASE_MESSAGING_SENDER_ID"
      - "FIREBASE_APP_ID"
      - "FIREBASE_MEASUREMENT_ID"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 2: CHECKOV â€” Scan Terraform for security issues
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Checkov is a static analysis tool for Infrastructure as Code.
  # It checks Terraform files for:
  #   - Security misconfigurations (public access, missing encryption)
  #   - Best practices (resource naming, tagging)
  #   - Compliance issues (CIS benchmarks)
  #
  # Non-blocking (--soft-fail): shows results but doesn't stop the build.
  # Remove --soft-fail to block deployment on security issues.
  #
  # View results: Cloud Build â†’ History â†’ click build â†’ Step 2 logs
  - name: "bridgecrew/checkov"
    id: "checkov-scan"
    entrypoint: "checkov"
    args:
      - "--directory"
      - "terraform"
      - "--framework"
      - "terraform"
      - "--soft-fail"
      - "--compact"
      - "--quiet"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 3: TF-INIT â€” Download providers
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Downloads the Google Cloud provider plugin.
  # Think of it like `npm install` for infrastructure.
  - name: "hashicorp/terraform:latest"
    id: "tf-init"
    entrypoint: "sh"
    args:
      - "-c"
      - |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  ğŸ“¦ Terraform Init â€” Downloading providers"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        terraform init -no-color
    dir: "terraform"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 4: TF-PLAN â€” Preview changes
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Shows what Terraform WILL do â€” without doing it yet.
  #   + means CREATE (new resource)
  #   ~ means UPDATE (change existing)
  #   - means DESTROY (delete resource)
  - name: "hashicorp/terraform:latest"
    id: "tf-plan"
    entrypoint: "sh"
    args:
      - "-c"
      - |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  ğŸ” Terraform Plan â€” Preview changes"
        echo "  Team: ${_TEAM}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        terraform plan \
          -var="student_namespace=${_TEAM}" \
          -var="project_id=${_PROJECT_ID}" \
          -var="image=${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_AR_REPO}/madina-lab-${_TEAM}:latest" \
          -no-color
    dir: "terraform"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 5: TF-APPLY â€” Create/update resources
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Actually creates the resources in GCP.
  # -auto-approve skips confirmation (since this is CI/CD).
  - name: "hashicorp/terraform:latest"
    id: "tf-apply"
    entrypoint: "sh"
    args:
      - "-c"
      - |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  ğŸš€ Terraform Apply â€” Creating resources"
        echo "  Team: ${_TEAM}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        terraform apply \
          -var="student_namespace=${_TEAM}" \
          -var="project_id=${_PROJECT_ID}" \
          -var="image=${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_AR_REPO}/madina-lab-${_TEAM}:latest" \
          -auto-approve \
          -no-color
    dir: "terraform"

# â”€â”€ Secrets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/firebase-api-key/versions/latest
      env: "FIREBASE_API_KEY"
    - versionName: projects/$PROJECT_ID/secrets/firebase-auth-domain/versions/latest
      env: "FIREBASE_AUTH_DOMAIN"
    - versionName: projects/$PROJECT_ID/secrets/firebase-project-id/versions/latest
      env: "FIREBASE_PROJECT_ID"
    - versionName: projects/$PROJECT_ID/secrets/firebase-storage-bucket/versions/latest
      env: "FIREBASE_STORAGE_BUCKET"
    - versionName: projects/$PROJECT_ID/secrets/firebase-messaging-sender-id/versions/latest
      env: "FIREBASE_MESSAGING_SENDER_ID"
    - versionName: projects/$PROJECT_ID/secrets/firebase-app-id/versions/latest
      env: "FIREBASE_APP_ID"
    - versionName: projects/$PROJECT_ID/secrets/firebase-measurement-id/versions/latest
      env: "FIREBASE_MEASUREMENT_ID"

options:
  logging: CLOUD_LOGGING_ONLY

timeout: "900s"