# =============================================================================
#  ğŸ•Œ  Madina Lab â€” Terraform Pipeline (cloudbuild-tf.yaml)
# =============================================================================
#
#  Builds the app, scans Terraform with Checkov, then deploys infra.
#
#  HOW TO USE:
#  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  gcloud builds submit --config .pipelines/cloudbuild-tf.yaml \
#    --substitutions=_TEAM=team1 .
#
#  PIPELINE STAGES:
#  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Step 1: BUILD-APP      â†’ Build & push container image
#  Step 2: CHECKOV-SCAN   â†’ Scan Terraform for security & best practices
#  Step 3: TF-INIT        â†’ Download providers & configure per-team backend
#  Step 4: TF-PLAN        â†’ Preview what will change
#  Step 5: TF-APPLY       â†’ Create/update resources
#
#  STATE ISOLATION:
#  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Each team gets its own state file in GCS:
#    gs://ml-gcp-workshop-487117-tfstate/terraform/state/team1/
#    gs://ml-gcp-workshop-487117-tfstate/terraform/state/team2/
#    ...
#  This means teams cannot interfere with each other's infrastructure.
#
# =============================================================================

substitutions:
  _TEAM: "team1"
  _REGION: "us-central1"
  _AR_REPO: "madina-lab"
  _PROJECT_ID: "ml-gcp-workshop-487117"
  _TF_STATE_BUCKET: "ml-gcp-workshop-487117-tfstate"

steps:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 1: BUILD-APP â€” Build & push container image
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Terraform deploys a Cloud Run service that references this image.
  # The image must exist in Artifact Registry before terraform apply.
  - name: "gcr.io/cloud-builders/docker"
    id: "build-app"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  ğŸ³ Building container image â€” ${_TEAM}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        docker build \
          --build-arg VITE_FIREBASE_API_KEY=$$FIREBASE_API_KEY \
          --build-arg VITE_FIREBASE_AUTH_DOMAIN=$$FIREBASE_AUTH_DOMAIN \
          --build-arg VITE_FIREBASE_PROJECT_ID=$$FIREBASE_PROJECT_ID \
          --build-arg VITE_FIREBASE_STORAGE_BUCKET=$$FIREBASE_STORAGE_BUCKET \
          --build-arg VITE_FIREBASE_MESSAGING_SENDER_ID=$$FIREBASE_MESSAGING_SENDER_ID \
          --build-arg VITE_FIREBASE_APP_ID=$$FIREBASE_APP_ID \
          --build-arg VITE_FIREBASE_MEASUREMENT_ID=$$FIREBASE_MEASUREMENT_ID \
          --build-arg VITE_APP_ENV=production \
          --build-arg VITE_NAMESPACE=${_TEAM} \
          -t ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/madina-lab-${_TEAM}:latest \
          .
        docker push ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/madina-lab-${_TEAM}:latest
        echo "âœ” Image built and pushed"
    secretEnv:
      - "FIREBASE_API_KEY"
      - "FIREBASE_AUTH_DOMAIN"
      - "FIREBASE_PROJECT_ID"
      - "FIREBASE_STORAGE_BUCKET"
      - "FIREBASE_MESSAGING_SENDER_ID"
      - "FIREBASE_APP_ID"
      - "FIREBASE_MEASUREMENT_ID"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 2: CHECKOV â€” Scan Terraform for security issues
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Checkov checks Terraform files for:
  #   - Security misconfigurations (public access, missing encryption)
  #   - Best practices (resource naming, tagging)
  #   - Compliance (CIS benchmarks)
  #
  # --soft-fail: shows results but doesn't stop the build
  # Remove --soft-fail to block deployment on security findings
  - name: "bridgecrew/checkov"
    id: "checkov-scan"
    entrypoint: "checkov"
    args:
      - "--directory"
      - "terraform"
      - "--framework"
      - "terraform"
      - "--soft-fail"
      - "--compact"
      - "--quiet"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 3: TF-INIT â€” Download providers & configure backend
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Downloads the Google Cloud provider plugin and configures
  # the GCS backend with a team-specific state path:
  #   gs://ml-gcp-workshop-487117-tfstate/terraform/state/team1/
  #   gs://ml-gcp-workshop-487117-tfstate/terraform/state/team2/
  #
  # Each team's state is isolated â€” teams can't affect each other.
  - name: "hashicorp/terraform:latest"
    id: "tf-init"
    entrypoint: "sh"
    args:
      - "-c"
      - |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  ğŸ“¦ Terraform Init"
        echo "  Backend: gs://${_TF_STATE_BUCKET}/terraform/state/${_TEAM}/"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        terraform init \
          -backend-config="prefix=terraform/state/${_TEAM}" \
          -no-color
    dir: "terraform"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 4: TF-PLAN â€” Preview changes
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Shows what Terraform WILL do â€” without doing it yet.
  #   + means CREATE (new resource)
  #   ~ means UPDATE (change existing)
  #   - means DESTROY (delete resource)
  #
  # -target limits to Cloud Run + IAM only (skip secrets â€” already created by setup.sh)
  - name: "hashicorp/terraform:latest"
    id: "tf-plan"
    entrypoint: "sh"
    args:
      - "-c"
      - |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  ğŸ” Terraform Plan â€” Team: ${_TEAM}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        terraform plan \
          -var="student_namespace=${_TEAM}" \
          -var="project_id=${_PROJECT_ID}" \
          -var="region=${_REGION}" \
          -var="image=${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_AR_REPO}/madina-lab-${_TEAM}:latest" \
          -target=google_cloud_run_v2_service.app \
          -target=google_cloud_run_v2_service_iam_member.public_access \
          -no-color
    dir: "terraform"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 5: TF-APPLY â€” Create/update resources
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Actually creates the resources in GCP.
  # -auto-approve skips confirmation (CI/CD context).
  - name: "hashicorp/terraform:latest"
    id: "tf-apply"
    entrypoint: "sh"
    args:
      - "-c"
      - |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  ğŸš€ Terraform Apply â€” Team: ${_TEAM}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        terraform apply \
          -var="student_namespace=${_TEAM}" \
          -var="project_id=${_PROJECT_ID}" \
          -var="region=${_REGION}" \
          -var="image=${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_AR_REPO}/madina-lab-${_TEAM}:latest" \
          -target=google_cloud_run_v2_service.app \
          -target=google_cloud_run_v2_service_iam_member.public_access \
          -auto-approve \
          -no-color
    dir: "terraform"

# â”€â”€ Secrets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/firebase-api-key/versions/latest
      env: "FIREBASE_API_KEY"
    - versionName: projects/$PROJECT_ID/secrets/firebase-auth-domain/versions/latest
      env: "FIREBASE_AUTH_DOMAIN"
    - versionName: projects/$PROJECT_ID/secrets/firebase-project-id/versions/latest
      env: "FIREBASE_PROJECT_ID"
    - versionName: projects/$PROJECT_ID/secrets/firebase-storage-bucket/versions/latest
      env: "FIREBASE_STORAGE_BUCKET"
    - versionName: projects/$PROJECT_ID/secrets/firebase-messaging-sender-id/versions/latest
      env: "FIREBASE_MESSAGING_SENDER_ID"
    - versionName: projects/$PROJECT_ID/secrets/firebase-app-id/versions/latest
      env: "FIREBASE_APP_ID"
    - versionName: projects/$PROJECT_ID/secrets/firebase-measurement-id/versions/latest
      env: "FIREBASE_MEASUREMENT_ID"

options:
  logging: CLOUD_LOGGING_ONLY

timeout: "900s"
tags:
  - "team-${_TEAM}"
  - "terraform-pipeline"